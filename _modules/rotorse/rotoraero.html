<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>rotorse.rotoraero &mdash; RotorSE 0.1.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/nrel.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="RotorSE 0.1.0 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="../../index.html">RotorSE 0.1.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for rotorse.rotoraero</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># encoding: utf-8</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">rotoraero.py</span>

<span class="sd">Created by Andrew Ning on 2013-10-07.</span>
<span class="sd">Copyright (c) NREL. All rights reserved.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span>
<span class="kn">from</span> <span class="nn">openmdao.main.api</span> <span class="kn">import</span> <span class="n">VariableTree</span><span class="p">,</span> <span class="n">Component</span><span class="p">,</span> <span class="n">Assembly</span><span class="p">,</span> <span class="n">ImplicitComponent</span>
<span class="kn">from</span> <span class="nn">openmdao.main.datatypes.api</span> <span class="kn">import</span> <span class="n">Int</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">Array</span><span class="p">,</span> <span class="n">VarTree</span><span class="p">,</span> <span class="n">Slot</span><span class="p">,</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">openmdao.lib.drivers.api</span> <span class="kn">import</span> <span class="n">Brent</span>

<span class="kn">from</span> <span class="nn">commonse.utilities</span> <span class="kn">import</span> <span class="n">hstack</span><span class="p">,</span> <span class="n">vstack</span><span class="p">,</span> <span class="n">linspace_with_deriv</span><span class="p">,</span> <span class="n">smooth_min</span><span class="p">,</span> <span class="n">trapz_deriv</span>
<span class="kn">from</span> <span class="nn">akima</span> <span class="kn">import</span> <span class="n">Akima</span>


<span class="c"># convert between rotations/minute and radians/second</span>
<span class="n">RPM2RS</span> <span class="o">=</span> <span class="n">pi</span><span class="o">/</span><span class="mf">30.0</span>
<span class="n">RS2RPM</span> <span class="o">=</span> <span class="mf">30.0</span><span class="o">/</span><span class="n">pi</span>


<span class="c"># ---------------------</span>
<span class="c"># Variable Trees</span>
<span class="c"># ---------------------</span>


<div class="viewcode-block" id="VarSpeedMachine"><a class="viewcode-back" href="../../documentation.html#rotorse.rotoraero.VarSpeedMachine">[docs]</a><span class="k">class</span> <span class="nc">VarSpeedMachine</span><span class="p">(</span><span class="n">VariableTree</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;variable speed machines&quot;&quot;&quot;</span>

    <span class="n">Vin</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s">&#39;m/s&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;cut-in wind speed&#39;</span><span class="p">)</span>
    <span class="n">Vout</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s">&#39;m/s&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;cut-out wind speed&#39;</span><span class="p">)</span>
    <span class="n">ratedPower</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s">&#39;W&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;rated power&#39;</span><span class="p">)</span>
    <span class="n">minOmega</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s">&#39;rpm&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;minimum allowed rotor rotation speed&#39;</span><span class="p">)</span>
    <span class="n">maxOmega</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s">&#39;rpm&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;maximum allowed rotor rotation speed&#39;</span><span class="p">)</span>
    <span class="n">tsr</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s">&#39;tip-speed ratio in Region 2 (should be optimized externally)&#39;</span><span class="p">)</span>
    <span class="n">pitch</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s">&#39;deg&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;pitch angle in region 2 (and region 3 for fixed pitch machines)&#39;</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="FixedSpeedMachine"><a class="viewcode-back" href="../../documentation.html#rotorse.rotoraero.FixedSpeedMachine">[docs]</a><span class="k">class</span> <span class="nc">FixedSpeedMachine</span><span class="p">(</span><span class="n">VariableTree</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;fixed speed machines&quot;&quot;&quot;</span>

    <span class="n">Vin</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s">&#39;m/s&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;cut-in wind speed&#39;</span><span class="p">)</span>
    <span class="n">Vout</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s">&#39;m/s&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;cut-out wind speed&#39;</span><span class="p">)</span>
    <span class="n">ratedPower</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s">&#39;W&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;rated power&#39;</span><span class="p">)</span>
    <span class="n">Omega</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s">&#39;rpm&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;fixed rotor rotation speed&#39;</span><span class="p">)</span>
    <span class="n">pitch</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s">&#39;deg&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;pitch angle in region 2 (and region 3 for fixed pitch machines)&#39;</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="RatedConditions"><a class="viewcode-back" href="../../documentation.html#rotorse.rotoraero.RatedConditions">[docs]</a><span class="k">class</span> <span class="nc">RatedConditions</span><span class="p">(</span><span class="n">VariableTree</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;aerodynamic conditions at the rated wind speed&quot;&quot;&quot;</span>

    <span class="n">V</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s">&#39;m/s&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;rated wind speed&#39;</span><span class="p">)</span>
    <span class="n">Omega</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s">&#39;rpm&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;rotor rotation speed at rated&#39;</span><span class="p">)</span>
    <span class="n">pitch</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s">&#39;deg&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;pitch setting at rated&#39;</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s">&#39;N&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;rotor aerodynamic thrust at rated&#39;</span><span class="p">)</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s">&#39;N*m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;rotor aerodynamic torque at rated&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="AeroLoads"><a class="viewcode-back" href="../../documentation.html#rotorse.rotoraero.AeroLoads">[docs]</a><span class="k">class</span> <span class="nc">AeroLoads</span><span class="p">(</span><span class="n">VariableTree</span><span class="p">):</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;radial positions along blade going toward tip&#39;</span><span class="p">)</span>
    <span class="n">Px</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s">&#39;N/m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;distributed loads in blade-aligned x-direction&#39;</span><span class="p">)</span>
    <span class="n">Py</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s">&#39;N/m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;distributed loads in blade-aligned y-direction&#39;</span><span class="p">)</span>
    <span class="n">Pz</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s">&#39;N/m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;distributed loads in blade-aligned z-direction&#39;</span><span class="p">)</span>

    <span class="c"># corresponding setting for loads</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s">&#39;m/s&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;hub height wind speed&#39;</span><span class="p">)</span>
    <span class="n">Omega</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s">&#39;rpm&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;rotor rotation speed&#39;</span><span class="p">)</span>
    <span class="n">pitch</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s">&#39;deg&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;pitch angle&#39;</span><span class="p">)</span>
    <span class="n">azimuth</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s">&#39;deg&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;azimuthal angle&#39;</span><span class="p">)</span>



<span class="c"># ---------------------</span>
<span class="c"># Base Components</span>
<span class="c"># ---------------------</span>
</div>
<div class="viewcode-block" id="GeomtrySetupBase"><a class="viewcode-back" href="../../documentation.html#rotorse.rotoraero.GeomtrySetupBase">[docs]</a><span class="k">class</span> <span class="nc">GeomtrySetupBase</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;a base component that computes the rotor radius from the geometry&quot;&quot;&quot;</span>

    <span class="n">R</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;rotor radius&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="AeroBase"><a class="viewcode-back" href="../../documentation.html#rotorse.rotoraero.AeroBase">[docs]</a><span class="k">class</span> <span class="nc">AeroBase</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A base component for a rotor aerodynamics code.&quot;&quot;&quot;</span>

    <span class="n">run_case</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">(</span><span class="s">&#39;power&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;power&#39;</span><span class="p">,</span> <span class="s">&#39;loads&#39;</span><span class="p">),</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">)</span>


    <span class="c"># --- use these if (run_case == &#39;power&#39;) ---</span>

    <span class="c"># inputs</span>
    <span class="n">Uhub</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;m/s&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;hub height wind speed&#39;</span><span class="p">)</span>
    <span class="n">Omega</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;rpm&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;rotor rotation speed&#39;</span><span class="p">)</span>
    <span class="n">pitch</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;deg&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;blade pitch setting&#39;</span><span class="p">)</span>

    <span class="c"># outputs</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;N&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;rotor aerodynamic thrust&#39;</span><span class="p">)</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;N*m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;rotor aerodynamic torque&#39;</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;W&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;rotor aerodynamic power&#39;</span><span class="p">)</span>


    <span class="c"># --- use these if (run_case == &#39;loads&#39;) ---</span>
    <span class="c"># if you only use rotoraero.py and not rotor.py</span>
    <span class="c"># (i.e., only care about power curves, and not structural loads)</span>
    <span class="c"># then these second set of inputs/outputs are not needed</span>

    <span class="c"># inputs</span>
    <span class="n">V_load</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;m/s&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;hub height wind speed&#39;</span><span class="p">)</span>
    <span class="n">Omega_load</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;rpm&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;rotor rotation speed&#39;</span><span class="p">)</span>
    <span class="n">pitch_load</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;deg&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;blade pitch setting&#39;</span><span class="p">)</span>
    <span class="n">azimuth_load</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;deg&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;blade azimuthal location&#39;</span><span class="p">)</span>

    <span class="c"># outputs</span>
    <span class="n">loads</span> <span class="o">=</span> <span class="n">VarTree</span><span class="p">(</span><span class="n">AeroLoads</span><span class="p">(),</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;loads in blade-aligned coordinate system&#39;</span><span class="p">)</span>



</div>
<div class="viewcode-block" id="DrivetrainLossesBase"><a class="viewcode-back" href="../../documentation.html#rotorse.rotoraero.DrivetrainLossesBase">[docs]</a><span class="k">class</span> <span class="nc">DrivetrainLossesBase</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;base component for drivetrain efficiency losses&quot;&quot;&quot;</span>

    <span class="n">aeroPower</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;W&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;aerodynamic power&#39;</span><span class="p">)</span>
    <span class="n">aeroTorque</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;N*m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;aerodynamic torque&#39;</span><span class="p">)</span>
    <span class="n">aeroThrust</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;N&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;aerodynamic thrust&#39;</span><span class="p">)</span>
    <span class="n">ratedPower</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;W&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;rated power&#39;</span><span class="p">)</span>

    <span class="n">power</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;W&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;total power after drivetrain losses&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="PDFBase"><a class="viewcode-back" href="../../documentation.html#rotorse.rotoraero.PDFBase">[docs]</a><span class="k">class</span> <span class="nc">PDFBase</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;probability distribution function&quot;&quot;&quot;</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">)</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="CDFBase"><a class="viewcode-back" href="../../documentation.html#rotorse.rotoraero.CDFBase">[docs]</a><span class="k">class</span> <span class="nc">CDFBase</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;cumulative distribution function&quot;&quot;&quot;</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">)</span>

    <span class="n">F</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">)</span>



<span class="c"># ---------------------</span>
<span class="c"># Components</span>
<span class="c"># ---------------------</span>

<span class="c"># class MaxTipSpeed(Component):</span>

<span class="c">#     R = Float(iotype=&#39;in&#39;, units=&#39;m&#39;, desc=&#39;rotor radius&#39;)</span>
<span class="c">#     Vtip_max = Float(iotype=&#39;in&#39;, units=&#39;m/s&#39;, desc=&#39;maximum tip speed&#39;)</span>

<span class="c">#     Omega_max = Float(iotype=&#39;out&#39;, units=&#39;rpm&#39;, desc=&#39;maximum rotation speed&#39;)</span>

<span class="c">#     def execute(self):</span>

<span class="c">#         self.Omega_max = self.Vtip_max/self.R * RS2RPM</span>


<span class="c">#     def list_deriv_vars(self):</span>

<span class="c">#         inputs = (&#39;R&#39;, &#39;Vtip_max&#39;)</span>
<span class="c">#         outputs = (&#39;Omega_max&#39;,)</span>

<span class="c">#         return inputs, outputs</span>


<span class="c">#     def provideJ(self):</span>

<span class="c">#         J = np.array([[-self.Vtip_max/self.R**2*RS2RPM, RS2RPM/self.R]])</span>

<span class="c">#         return J</span>


<span class="c"># This Component is now no longer used, but I&#39;ll keep it around for now in case that changes.</span></div>
<span class="k">class</span> <span class="nc">Coefficients</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;convert power, thrust, torque into nondimensional coefficient form&quot;&quot;&quot;</span>

    <span class="c"># inputs</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;m/s&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;wind speed&#39;</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;N&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;rotor aerodynamic thrust&#39;</span><span class="p">)</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;N*m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;rotor aerodynamic torque&#39;</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;W&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;rotor aerodynamic power&#39;</span><span class="p">)</span>

    <span class="c"># inputs used in normalization</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;rotor radius&#39;</span><span class="p">)</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;kg/m**3&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;density of fluid&#39;</span><span class="p">)</span>


    <span class="c"># outputs</span>
    <span class="n">CT</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;rotor aerodynamic thrust&#39;</span><span class="p">)</span>
    <span class="n">CQ</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;rotor aerodynamic torque&#39;</span><span class="p">)</span>
    <span class="n">CP</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;rotor aerodynamic power&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">q</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">**</span><span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">/</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="n">A</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="n">A</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CQ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="o">/</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">*</span> <span class="n">A</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">list_deriv_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;V&#39;</span><span class="p">,</span> <span class="s">&#39;T&#39;</span><span class="p">,</span> <span class="s">&#39;Q&#39;</span><span class="p">,</span> <span class="s">&#39;P&#39;</span><span class="p">,</span> <span class="s">&#39;R&#39;</span><span class="p">)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;CT&#39;</span><span class="p">,</span> <span class="s">&#39;CQ&#39;</span><span class="p">,</span> <span class="s">&#39;CP&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span>


    <span class="k">def</span> <span class="nf">provideJ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span>
        <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span>
        <span class="n">CT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CT</span>
        <span class="n">CQ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CQ</span>
        <span class="n">CP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CP</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">*</span> <span class="n">V</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">R</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">zeronn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>

        <span class="n">dCT_dV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">CT</span><span class="o">/</span><span class="n">V</span><span class="p">)</span>
        <span class="n">dCT_dT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">q</span><span class="o">*</span><span class="n">A</span><span class="p">))</span>
        <span class="n">dCT_dR</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">CT</span><span class="o">/</span><span class="n">R</span>
        <span class="n">dCT</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">((</span><span class="n">dCT_dV</span><span class="p">,</span> <span class="n">dCT_dT</span><span class="p">,</span> <span class="n">zeronn</span><span class="p">,</span> <span class="n">zeronn</span><span class="p">,</span> <span class="n">dCT_dR</span><span class="p">))</span>

        <span class="n">dCQ_dV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">CQ</span><span class="o">/</span><span class="n">V</span><span class="p">)</span>
        <span class="n">dCQ_dQ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">q</span><span class="o">*</span><span class="n">R</span><span class="o">*</span><span class="n">A</span><span class="p">))</span>
        <span class="n">dCQ_dR</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.0</span><span class="o">*</span><span class="n">CQ</span><span class="o">/</span><span class="n">R</span>
        <span class="n">dCQ</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">((</span><span class="n">dCQ_dV</span><span class="p">,</span> <span class="n">zeronn</span><span class="p">,</span> <span class="n">dCQ_dQ</span><span class="p">,</span> <span class="n">zeronn</span><span class="p">,</span> <span class="n">dCQ_dR</span><span class="p">))</span>

        <span class="n">dCP_dV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="o">-</span><span class="mf">3.0</span><span class="o">*</span><span class="n">CP</span><span class="o">/</span><span class="n">V</span><span class="p">)</span>
        <span class="n">dCP_dP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">q</span><span class="o">*</span><span class="n">A</span><span class="o">*</span><span class="n">V</span><span class="p">))</span>
        <span class="n">dCP_dR</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">CP</span><span class="o">/</span><span class="n">R</span>
        <span class="n">dCP</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">((</span><span class="n">dCP_dV</span><span class="p">,</span> <span class="n">zeronn</span><span class="p">,</span> <span class="n">zeronn</span><span class="p">,</span> <span class="n">dCP_dP</span><span class="p">,</span> <span class="n">dCP_dR</span><span class="p">))</span>

        <span class="n">J</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">((</span><span class="n">dCT</span><span class="p">,</span> <span class="n">dCQ</span><span class="p">,</span> <span class="n">dCP</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">J</span>



<span class="k">class</span> <span class="nc">SetupRunFixedSpeed</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;determines approriate conditions to run AeroBase code across the power curve&quot;&quot;&quot;</span>

    <span class="n">control</span> <span class="o">=</span> <span class="n">VarTree</span><span class="p">(</span><span class="n">FixedSpeedMachine</span><span class="p">(),</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;control parameters&#39;</span><span class="p">)</span>
    <span class="n">npts</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;number of points to evalute aero code to generate power curve&#39;</span><span class="p">)</span>

    <span class="c"># outputs</span>
    <span class="n">Uhub</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;m/s&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;freestream velocities to run&#39;</span><span class="p">)</span>
    <span class="n">Omega</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;rpm&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;rotation speeds to run&#39;</span><span class="p">)</span>
    <span class="n">pitch</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;deg&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;pitch angles to run&#39;</span><span class="p">)</span>

    <span class="n">missing_deriv_policy</span> <span class="o">=</span> <span class="s">&#39;assume_zero&#39;</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npts</span>

        <span class="c"># velocity sweep</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ctrl</span><span class="o">.</span><span class="n">Vin</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">Vout</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="c"># store values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Uhub</span> <span class="o">=</span> <span class="n">V</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Omega</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">Omega</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">pitch</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">list_deriv_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,)</span>  <span class="c"># everything is constant</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,)</span>

        <span class="k">return</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span>

    <span class="k">def</span> <span class="nf">provideJ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="p">[]</span>



<span class="k">class</span> <span class="nc">SetupRunVarSpeed</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;determines approriate conditions to run AeroBase code across the power curve&quot;&quot;&quot;</span>

    <span class="n">control</span> <span class="o">=</span> <span class="n">VarTree</span><span class="p">(</span><span class="n">VarSpeedMachine</span><span class="p">(),</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;control parameters&#39;</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;rotor radius&#39;</span><span class="p">)</span>
    <span class="n">npts</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;number of points to evalute aero code to generate power curve&#39;</span><span class="p">)</span>

    <span class="c"># outputs</span>
    <span class="n">Uhub</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;m/s&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;freestream velocities to run&#39;</span><span class="p">)</span>
    <span class="n">Omega</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;rpm&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;rotation speeds to run&#39;</span><span class="p">)</span>
    <span class="n">pitch</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;deg&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;pitch angles to run&#39;</span><span class="p">)</span>

    <span class="n">missing_deriv_policy</span> <span class="o">=</span> <span class="s">&#39;assume_zero&#39;</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npts</span>
        <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span>

        <span class="c"># # attempt to distribute points mostly before rated</span>
        <span class="c"># cpguess = 0.5</span>
        <span class="c"># Vr0 = (ctrl.ratedPower/(cpguess*0.5*rho*pi*R**2))**(1.0/3)</span>
        <span class="c"># Vr0 *= 1.20</span>

        <span class="c"># V1 = np.linspace(Vin, Vr0, 15)</span>
        <span class="c"># V2 = np.linspace(Vr0, Vout, 6)</span>
        <span class="c"># V = np.concatenate([V1, V2[1:]])</span>

        <span class="c"># velocity sweep</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ctrl</span><span class="o">.</span><span class="n">Vin</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">Vout</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="c"># corresponding rotation speed</span>
        <span class="n">Omega_d</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">tsr</span><span class="o">*</span><span class="n">V</span><span class="o">/</span><span class="n">R</span><span class="o">*</span><span class="n">RS2RPM</span>
        <span class="n">Omega</span><span class="p">,</span> <span class="n">dOmega_dOmegad</span><span class="p">,</span> <span class="n">dOmega_dmaxOmega</span> <span class="o">=</span> <span class="n">smooth_min</span><span class="p">(</span><span class="n">Omega_d</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">maxOmega</span><span class="p">,</span> <span class="n">pct_offset</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

        <span class="c"># store values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Uhub</span> <span class="o">=</span> <span class="n">V</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Omega</span> <span class="o">=</span> <span class="n">Omega</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">pitch</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>

        <span class="c"># gradients</span>
        <span class="n">dV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">dOmega_dtsr</span> <span class="o">=</span> <span class="n">dOmega_dOmegad</span> <span class="o">*</span> <span class="n">V</span><span class="o">/</span><span class="n">R</span><span class="o">*</span><span class="n">RS2RPM</span>
        <span class="n">dOmega_dR</span> <span class="o">=</span> <span class="n">dOmega_dOmegad</span> <span class="o">*</span> <span class="o">-</span><span class="n">ctrl</span><span class="o">.</span><span class="n">tsr</span><span class="o">*</span><span class="n">V</span><span class="o">/</span><span class="n">R</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">RS2RPM</span>
        <span class="n">dOmega</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">([</span><span class="n">dOmega_dtsr</span><span class="p">,</span> <span class="n">dOmega_dR</span><span class="p">,</span> <span class="n">dOmega_dmaxOmega</span><span class="p">])</span>
        <span class="n">dpitch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">J</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">([</span><span class="n">dV</span><span class="p">,</span> <span class="n">dOmega</span><span class="p">,</span> <span class="n">dpitch</span><span class="p">])</span>


    <span class="k">def</span> <span class="nf">list_deriv_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;control.tsr&#39;</span><span class="p">,</span> <span class="s">&#39;R&#39;</span><span class="p">,</span> <span class="s">&#39;control.maxOmega&#39;</span><span class="p">)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Uhub&#39;</span><span class="p">,</span> <span class="s">&#39;Omega&#39;</span><span class="p">,</span> <span class="s">&#39;pitch&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span>

    <span class="k">def</span> <span class="nf">provideJ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">J</span>





<span class="k">class</span> <span class="nc">UnregulatedPowerCurve</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>

    <span class="c"># inputs</span>
    <span class="n">control</span> <span class="o">=</span> <span class="n">VarTree</span><span class="p">(</span><span class="n">FixedSpeedMachine</span><span class="p">(),</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;control parameters&#39;</span><span class="p">)</span>
    <span class="n">Vcoarse</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;m/s&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;wind speeds&#39;</span><span class="p">)</span>
    <span class="n">Pcoarse</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;W&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;unregulated power curve (but after drivetrain losses)&#39;</span><span class="p">)</span>
    <span class="n">Tcoarse</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;N&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;unregulated thrust curve&#39;</span><span class="p">)</span>
    <span class="n">npts</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;number of points for splined power curve&#39;</span><span class="p">)</span>


    <span class="c"># outputs</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;m/s&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;wind speeds&#39;</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;W&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;power&#39;</span><span class="p">)</span>

    <span class="n">missing_deriv_policy</span> <span class="o">=</span> <span class="s">&#39;assume_zero&#39;</span>


    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npts</span>

        <span class="c"># finer power curve</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">linspace_with_deriv</span><span class="p">(</span><span class="n">ctrl</span><span class="o">.</span><span class="n">Vin</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">Vout</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">spline</span> <span class="o">=</span> <span class="n">Akima</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vcoarse</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Pcoarse</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="n">dP_dV</span><span class="p">,</span> <span class="n">dP_dVcoarse</span><span class="p">,</span> <span class="n">dP_dPcoarse</span> <span class="o">=</span> <span class="n">spline</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">J</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">([</span><span class="n">dP_dVcoarse</span><span class="p">,</span> <span class="n">dP_dPcoarse</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">list_deriv_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Vcoarse&#39;</span><span class="p">,</span> <span class="s">&#39;Pcoarse&#39;</span><span class="p">)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;P&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span>

    <span class="k">def</span> <span class="nf">provideJ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">J</span>


<span class="k">class</span> <span class="nc">RegulatedPowerCurve</span><span class="p">(</span><span class="n">ImplicitComponent</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fit a spline to the coarse sampled power curve (and thrust curve),</span>
<span class="sd">    find rated speed through a residual convergence strategy,</span>
<span class="sd">    then compute the regulated power curve and rated conditions&quot;&quot;&quot;</span>

    <span class="c"># inputs</span>
    <span class="n">control</span> <span class="o">=</span> <span class="n">VarTree</span><span class="p">(</span><span class="n">VarSpeedMachine</span><span class="p">(),</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;control parameters&#39;</span><span class="p">)</span>
    <span class="n">Vcoarse</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;m/s&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;wind speeds&#39;</span><span class="p">)</span>
    <span class="n">Pcoarse</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;W&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;unregulated power curve (but after drivetrain losses)&#39;</span><span class="p">)</span>
    <span class="n">Tcoarse</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;N&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;unregulated thrust curve&#39;</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;rotor radius&#39;</span><span class="p">)</span>
    <span class="n">npts</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;number of points for splined power curve&#39;</span><span class="p">)</span>

    <span class="c"># state</span>
    <span class="n">Vrated</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;state&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;m/s&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;rated wind speed&#39;</span><span class="p">)</span>

    <span class="c"># residual</span>
    <span class="n">residual</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&quot;residual&quot;</span><span class="p">)</span>

    <span class="c"># outputs</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;m/s&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;wind speeds&#39;</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;W&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;power&#39;</span><span class="p">)</span>
    <span class="n">ratedConditions</span> <span class="o">=</span> <span class="n">VarTree</span><span class="p">(</span><span class="n">RatedConditions</span><span class="p">(),</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;conditions at rated speed&#39;</span><span class="p">)</span>

    <span class="n">missing_deriv_policy</span> <span class="o">=</span> <span class="s">&#39;assume_zero&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RegulatedPowerCurve</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_only</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c"># allows an external solver to converge this, otherwise it will converge itself to mimic an explicit comp</span>


    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npts</span>
        <span class="n">Vrated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vrated</span>

        <span class="c"># residual</span>
        <span class="n">spline</span> <span class="o">=</span> <span class="n">Akima</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vcoarse</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Pcoarse</span><span class="p">)</span>
        <span class="n">P</span><span class="p">,</span> <span class="n">dres_dVrated</span><span class="p">,</span> <span class="n">dres_dVcoarse</span><span class="p">,</span> <span class="n">dres_dPcoarse</span> <span class="o">=</span> <span class="n">spline</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">Vrated</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residual</span> <span class="o">=</span> <span class="n">P</span> <span class="o">-</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">ratedPower</span>

        <span class="c"># functional</span>

        <span class="c"># place half of points in region 2, half in region 3</span>
        <span class="c"># even though region 3 is constant we still need lots of points there</span>
        <span class="c"># because we will be integrating against a discretized wind</span>
        <span class="c"># speed distribution</span>

        <span class="c"># region 2</span>
        <span class="n">V2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dV2_dVrated</span> <span class="o">=</span> <span class="n">linspace_with_deriv</span><span class="p">(</span><span class="n">ctrl</span><span class="o">.</span><span class="n">Vin</span><span class="p">,</span> <span class="n">Vrated</span><span class="p">,</span> <span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">P2</span><span class="p">,</span> <span class="n">dP2_dV2</span><span class="p">,</span> <span class="n">dP2_dVcoarse</span><span class="p">,</span> <span class="n">dP2_dPcoarse</span> <span class="o">=</span> <span class="n">spline</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">V2</span><span class="p">)</span>

        <span class="c"># region 3</span>
        <span class="n">V3</span><span class="p">,</span> <span class="n">dV3_dVrated</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">linspace_with_deriv</span><span class="p">(</span><span class="n">Vrated</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">Vout</span><span class="p">,</span> <span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">V3</span> <span class="o">=</span> <span class="n">V3</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>  <span class="c"># remove duplicate point</span>
        <span class="n">dV3_dVrated</span> <span class="o">=</span> <span class="n">dV3_dVrated</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">P3</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">ratedPower</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">V3</span><span class="p">)</span>

        <span class="c"># concatenate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">V2</span><span class="p">,</span> <span class="n">V3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">P2</span><span class="p">,</span> <span class="n">P3</span><span class="p">])</span>

        <span class="c"># rated speed conditions</span>
        <span class="n">Omega_d</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">tsr</span><span class="o">*</span><span class="n">Vrated</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">*</span><span class="n">RS2RPM</span>
        <span class="n">OmegaRated</span><span class="p">,</span> <span class="n">dOmegaRated_dOmegad</span><span class="p">,</span> <span class="n">dOmegaRated_dmaxOmega</span> \
            <span class="o">=</span> <span class="n">smooth_min</span><span class="p">(</span><span class="n">Omega_d</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">maxOmega</span><span class="p">,</span> <span class="n">pct_offset</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

        <span class="n">splineT</span> <span class="o">=</span> <span class="n">Akima</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vcoarse</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tcoarse</span><span class="p">)</span>
        <span class="n">Trated</span><span class="p">,</span> <span class="n">dT_dVrated</span><span class="p">,</span> <span class="n">dT_dVcoarse</span><span class="p">,</span> <span class="n">dT_dTcoarse</span> <span class="o">=</span> <span class="n">splineT</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">Vrated</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ratedConditions</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">Vrated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratedConditions</span><span class="o">.</span><span class="n">Omega</span> <span class="o">=</span> <span class="n">OmegaRated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratedConditions</span><span class="o">.</span><span class="n">pitch</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">pitch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratedConditions</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">Trated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratedConditions</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">ratedPower</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ratedConditions</span><span class="o">.</span><span class="n">Omega</span> <span class="o">*</span> <span class="n">RPM2RS</span><span class="p">)</span>


        <span class="c"># gradients</span>
        <span class="n">ncoarse</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vcoarse</span><span class="p">)</span>

        <span class="n">dres</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dres_dVcoarse</span><span class="p">,</span> <span class="n">dres_dPcoarse</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ncoarse</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dres_dVrated</span><span class="p">]),</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]])</span>

        <span class="n">dV_dVrated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">dV2_dVrated</span><span class="p">,</span> <span class="n">dV3_dVrated</span><span class="p">])</span>
        <span class="n">dV</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">ncoarse</span><span class="p">)),</span> <span class="n">dV_dVrated</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">))])</span>

        <span class="n">dP_dVcoarse</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">([</span><span class="n">dP2_dVcoarse</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncoarse</span><span class="p">))])</span>
        <span class="n">dP_dPcoarse</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">([</span><span class="n">dP2_dPcoarse</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncoarse</span><span class="p">))])</span>
        <span class="n">dP_dVrated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">dP2_dV2</span><span class="o">*</span><span class="n">dV2_dVrated</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">)])</span>
        <span class="n">dP</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">dP_dVcoarse</span><span class="p">,</span> <span class="n">dP_dPcoarse</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">ncoarse</span><span class="p">)),</span> <span class="n">dP_dVrated</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">))])</span>

        <span class="n">drV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">ncoarse</span><span class="p">),</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]])</span>
        <span class="n">drOmega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">dOmegaRated_dOmegad</span><span class="o">*</span><span class="n">Vrated</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">*</span><span class="n">RS2RPM</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">ncoarse</span><span class="p">),</span>
            <span class="p">[</span><span class="n">dOmegaRated_dOmegad</span><span class="o">*</span><span class="n">ctrl</span><span class="o">.</span><span class="n">tsr</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">*</span><span class="n">RS2RPM</span><span class="p">,</span> <span class="o">-</span><span class="n">dOmegaRated_dOmegad</span><span class="o">*</span><span class="n">ctrl</span><span class="o">.</span><span class="n">tsr</span><span class="o">*</span><span class="n">Vrated</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">RS2RPM</span><span class="p">,</span>
            <span class="n">dOmegaRated_dmaxOmega</span><span class="p">]])</span>
        <span class="n">drpitch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">ncoarse</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">drT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dT_dVcoarse</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ncoarse</span><span class="p">),</span> <span class="n">dT_dTcoarse</span><span class="p">,</span> <span class="p">[</span><span class="n">dT_dVrated</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]])</span>
        <span class="n">drQ</span> <span class="o">=</span> <span class="o">-</span><span class="n">ctrl</span><span class="o">.</span><span class="n">ratedPower</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ratedConditions</span><span class="o">.</span><span class="n">Omega</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">RPM2RS</span><span class="p">)</span> <span class="o">*</span> <span class="n">drOmega</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">J</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">([</span><span class="n">dres</span><span class="p">,</span> <span class="n">dV</span><span class="p">,</span> <span class="n">dP</span><span class="p">,</span> <span class="n">drV</span><span class="p">,</span> <span class="n">drOmega</span><span class="p">,</span> <span class="n">drpitch</span><span class="p">,</span> <span class="n">drT</span><span class="p">,</span> <span class="n">drQ</span><span class="p">])</span>


    <span class="k">def</span> <span class="nf">list_deriv_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;control.tsr&#39;</span><span class="p">,</span> <span class="s">&#39;Vcoarse&#39;</span><span class="p">,</span> <span class="s">&#39;Pcoarse&#39;</span><span class="p">,</span> <span class="s">&#39;Tcoarse&#39;</span><span class="p">,</span> <span class="s">&#39;Vrated&#39;</span><span class="p">,</span> <span class="s">&#39;R&#39;</span><span class="p">,</span> <span class="s">&#39;control.maxOmega&#39;</span><span class="p">)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;residual&#39;</span><span class="p">,</span> <span class="s">&#39;V&#39;</span><span class="p">,</span> <span class="s">&#39;P&#39;</span><span class="p">,</span> <span class="s">&#39;ratedConditions.V&#39;</span><span class="p">,</span> <span class="s">&#39;ratedConditions.Omega&#39;</span><span class="p">,</span>
            <span class="s">&#39;ratedConditions.pitch&#39;</span><span class="p">,</span> <span class="s">&#39;ratedConditions.T&#39;</span><span class="p">,</span> <span class="s">&#39;ratedConditions.Q&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span>

    <span class="k">def</span> <span class="nf">provideJ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">J</span>






<span class="k">class</span> <span class="nc">AEP</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;integrate to find annual energy production&quot;&quot;&quot;</span>

    <span class="c"># inputs</span>
    <span class="n">CDF_V</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;cumulative distribution function evaluated at each wind speed&#39;</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;W&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;power curve (power)&#39;</span><span class="p">)</span>
    <span class="n">lossFactor</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;multiplicative factor for availability and other losses (soiling, array, etc.)&#39;</span><span class="p">)</span>

    <span class="c"># outputs</span>
    <span class="n">AEP</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;kW*h&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;annual energy production&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">AEP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lossFactor</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">CDF_V</span><span class="p">)</span><span class="o">/</span><span class="mf">1e3</span><span class="o">*</span><span class="mf">365.0</span><span class="o">*</span><span class="mf">24.0</span>  <span class="c"># in kWh</span>


    <span class="k">def</span> <span class="nf">list_deriv_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;CDF_V&#39;</span><span class="p">,</span> <span class="s">&#39;P&#39;</span><span class="p">,</span> <span class="s">&#39;lossFactor&#39;</span><span class="p">)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;AEP&#39;</span><span class="p">,)</span>

        <span class="k">return</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span>


    <span class="k">def</span> <span class="nf">provideJ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lossFactor</span><span class="o">/</span><span class="mf">1e3</span><span class="o">*</span><span class="mf">365.0</span><span class="o">*</span><span class="mf">24.0</span>

        <span class="n">dAEP_dP</span><span class="p">,</span> <span class="n">dAEP_dCDF</span> <span class="o">=</span> <span class="n">trapz_deriv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">CDF_V</span><span class="p">)</span>
        <span class="n">dAEP_dP</span> <span class="o">*=</span> <span class="n">factor</span>
        <span class="n">dAEP_dCDF</span> <span class="o">*=</span> <span class="n">factor</span>

        <span class="n">dAEP_dlossFactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">AEP</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">lossFactor</span><span class="p">])</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">)</span>
        <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">J</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">dAEP_dCDF</span>
        <span class="n">J</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">dAEP_dP</span>
        <span class="n">J</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">dAEP_dlossFactor</span>

        <span class="k">return</span> <span class="n">J</span>



<span class="c"># ---------------------</span>
<span class="c"># Assemblies</span>
<span class="c"># ---------------------</span>


<span class="k">def</span> <span class="nf">common_io</span><span class="p">(</span><span class="n">assembly</span><span class="p">,</span> <span class="n">varspeed</span><span class="p">,</span> <span class="n">varpitch</span><span class="p">):</span>

    <span class="n">regulated</span> <span class="o">=</span> <span class="n">varspeed</span> <span class="ow">or</span> <span class="n">varpitch</span>

    <span class="c"># add inputs</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;npts_coarse_power_curve&#39;</span><span class="p">,</span> <span class="n">Int</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;number of points to evaluate aero analysis at&#39;</span><span class="p">))</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;npts_spline_power_curve&#39;</span><span class="p">,</span> <span class="n">Int</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;number of points to use in fitting spline to power curve&#39;</span><span class="p">))</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;AEP_loss_factor&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;availability and other losses (soiling, array, etc.)&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">varspeed</span><span class="p">:</span>
        <span class="n">assembly</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;control&#39;</span><span class="p">,</span> <span class="n">VarTree</span><span class="p">(</span><span class="n">VarSpeedMachine</span><span class="p">(),</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;control parameters&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">assembly</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;control&#39;</span><span class="p">,</span> <span class="n">VarTree</span><span class="p">(</span><span class="n">FixedSpeedMachine</span><span class="p">(),</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;control parameters&#39;</span><span class="p">))</span>


    <span class="c"># add slots (must replace)</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;geom&#39;</span><span class="p">,</span> <span class="n">Slot</span><span class="p">(</span><span class="n">GeomtrySetupBase</span><span class="p">))</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;analysis&#39;</span><span class="p">,</span> <span class="n">Slot</span><span class="p">(</span><span class="n">AeroBase</span><span class="p">))</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;dt&#39;</span><span class="p">,</span> <span class="n">Slot</span><span class="p">(</span><span class="n">DrivetrainLossesBase</span><span class="p">))</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;cdf&#39;</span><span class="p">,</span> <span class="n">Slot</span><span class="p">(</span><span class="n">CDFBase</span><span class="p">))</span>


    <span class="c"># add outputs</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;AEP&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;kW*h&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;annual energy production&#39;</span><span class="p">))</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;V&#39;</span><span class="p">,</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;m/s&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;wind speeds (power curve)&#39;</span><span class="p">))</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;P&#39;</span><span class="p">,</span> <span class="n">Array</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;W&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;power (power curve)&#39;</span><span class="p">))</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;diameter&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;m&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;rotor diameter&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">regulated</span><span class="p">:</span>
        <span class="n">assembly</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;ratedConditions&#39;</span><span class="p">,</span> <span class="n">VarTree</span><span class="p">(</span><span class="n">RatedConditions</span><span class="p">(),</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">common_configure</span><span class="p">(</span><span class="n">assembly</span><span class="p">,</span> <span class="n">varspeed</span><span class="p">,</span> <span class="n">varpitch</span><span class="p">):</span>

    <span class="n">regulated</span> <span class="o">=</span> <span class="n">varspeed</span> <span class="ow">or</span> <span class="n">varpitch</span>

    <span class="c"># add components</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;geom&#39;</span><span class="p">,</span> <span class="n">GeomtrySetupBase</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">varspeed</span><span class="p">:</span>
        <span class="n">assembly</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;setup&#39;</span><span class="p">,</span> <span class="n">SetupRunVarSpeed</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">assembly</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;setup&#39;</span><span class="p">,</span> <span class="n">SetupRunFixedSpeed</span><span class="p">())</span>

    <span class="n">assembly</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;analysis&#39;</span><span class="p">,</span> <span class="n">AeroBase</span><span class="p">())</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;dt&#39;</span><span class="p">,</span> <span class="n">DrivetrainLossesBase</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">varspeed</span> <span class="ow">or</span> <span class="n">varpitch</span><span class="p">:</span>
        <span class="n">assembly</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;powercurve&#39;</span><span class="p">,</span> <span class="n">RegulatedPowerCurve</span><span class="p">())</span>
        <span class="n">assembly</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;brent&#39;</span><span class="p">,</span> <span class="n">Brent</span><span class="p">())</span>
        <span class="n">assembly</span><span class="o">.</span><span class="n">brent</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">add</span><span class="p">([</span><span class="s">&#39;powercurve&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">assembly</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;powercurve&#39;</span><span class="p">,</span> <span class="n">UnregulatedPowerCurve</span><span class="p">())</span>

    <span class="n">assembly</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;cdf&#39;</span><span class="p">,</span> <span class="n">CDFBase</span><span class="p">())</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;aep&#39;</span><span class="p">,</span> <span class="n">AEP</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">regulated</span><span class="p">:</span>
        <span class="n">assembly</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">add</span><span class="p">([</span><span class="s">&#39;geom&#39;</span><span class="p">,</span> <span class="s">&#39;setup&#39;</span><span class="p">,</span> <span class="s">&#39;analysis&#39;</span><span class="p">,</span> <span class="s">&#39;dt&#39;</span><span class="p">,</span> <span class="s">&#39;brent&#39;</span><span class="p">,</span> <span class="s">&#39;cdf&#39;</span><span class="p">,</span> <span class="s">&#39;aep&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">assembly</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">add</span><span class="p">([</span><span class="s">&#39;geom&#39;</span><span class="p">,</span> <span class="s">&#39;setup&#39;</span><span class="p">,</span> <span class="s">&#39;analysis&#39;</span><span class="p">,</span> <span class="s">&#39;dt&#39;</span><span class="p">,</span> <span class="s">&#39;powercurve&#39;</span><span class="p">,</span> <span class="s">&#39;cdf&#39;</span><span class="p">,</span> <span class="s">&#39;aep&#39;</span><span class="p">])</span>


    <span class="c"># connections to setup</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;control&#39;</span><span class="p">,</span> <span class="s">&#39;setup.control&#39;</span><span class="p">)</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;npts_coarse_power_curve&#39;</span><span class="p">,</span> <span class="s">&#39;setup.npts&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">varspeed</span><span class="p">:</span>
        <span class="n">assembly</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;geom.R&#39;</span><span class="p">,</span> <span class="s">&#39;setup.R&#39;</span><span class="p">)</span>


    <span class="c"># connections to analysis</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;setup.Uhub&#39;</span><span class="p">,</span> <span class="s">&#39;analysis.Uhub&#39;</span><span class="p">)</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;setup.Omega&#39;</span><span class="p">,</span> <span class="s">&#39;analysis.Omega&#39;</span><span class="p">)</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;setup.pitch&#39;</span><span class="p">,</span> <span class="s">&#39;analysis.pitch&#39;</span><span class="p">)</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">run_case</span> <span class="o">=</span> <span class="s">&#39;power&#39;</span>


    <span class="c"># connections to drivetrain</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;analysis.P&#39;</span><span class="p">,</span> <span class="s">&#39;dt.aeroPower&#39;</span><span class="p">)</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;analysis.Q&#39;</span><span class="p">,</span> <span class="s">&#39;dt.aeroTorque&#39;</span><span class="p">)</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;analysis.T&#39;</span><span class="p">,</span> <span class="s">&#39;dt.aeroThrust&#39;</span><span class="p">)</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;control.ratedPower&#39;</span><span class="p">,</span> <span class="s">&#39;dt.ratedPower&#39;</span><span class="p">)</span>


    <span class="c"># connections to powercurve</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;control&#39;</span><span class="p">,</span> <span class="s">&#39;powercurve.control&#39;</span><span class="p">)</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;setup.Uhub&#39;</span><span class="p">,</span> <span class="s">&#39;powercurve.Vcoarse&#39;</span><span class="p">)</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;dt.power&#39;</span><span class="p">,</span> <span class="s">&#39;powercurve.Pcoarse&#39;</span><span class="p">)</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;analysis.T&#39;</span><span class="p">,</span> <span class="s">&#39;powercurve.Tcoarse&#39;</span><span class="p">)</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;npts_spline_power_curve&#39;</span><span class="p">,</span> <span class="s">&#39;powercurve.npts&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">regulated</span><span class="p">:</span>
        <span class="n">assembly</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;geom.R&#39;</span><span class="p">,</span> <span class="s">&#39;powercurve.R&#39;</span><span class="p">)</span>

        <span class="c"># setup Brent method to find rated speed</span>
        <span class="n">assembly</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;control.Vin&#39;</span><span class="p">,</span> <span class="s">&#39;brent.lower_bound&#39;</span><span class="p">)</span>
        <span class="n">assembly</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;control.Vout&#39;</span><span class="p">,</span> <span class="s">&#39;brent.upper_bound&#39;</span><span class="p">)</span>
        <span class="n">assembly</span><span class="o">.</span><span class="n">brent</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s">&#39;powercurve.Vrated&#39;</span><span class="p">,</span> <span class="n">low</span><span class="o">=-</span><span class="mf">1e-15</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">1e15</span><span class="p">)</span>
        <span class="n">assembly</span><span class="o">.</span><span class="n">brent</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="s">&#39;powercurve.residual = 0&#39;</span><span class="p">)</span>
        <span class="n">assembly</span><span class="o">.</span><span class="n">brent</span><span class="o">.</span><span class="n">invalid_bracket_return</span> <span class="o">=</span> <span class="mf">1.0</span>


    <span class="c"># connections to cdf</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;powercurve.V&#39;</span><span class="p">,</span> <span class="s">&#39;cdf.x&#39;</span><span class="p">)</span>


    <span class="c"># connections to aep</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;cdf.F&#39;</span><span class="p">,</span> <span class="s">&#39;aep.CDF_V&#39;</span><span class="p">)</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;powercurve.P&#39;</span><span class="p">,</span> <span class="s">&#39;aep.P&#39;</span><span class="p">)</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;AEP_loss_factor&#39;</span><span class="p">,</span> <span class="s">&#39;aep.lossFactor&#39;</span><span class="p">)</span>


    <span class="c"># connections to outputs</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;powercurve.V&#39;</span><span class="p">,</span> <span class="s">&#39;V&#39;</span><span class="p">)</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;powercurve.P&#39;</span><span class="p">,</span> <span class="s">&#39;P&#39;</span><span class="p">)</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;aep.AEP&#39;</span><span class="p">,</span> <span class="s">&#39;AEP&#39;</span><span class="p">)</span>
    <span class="n">assembly</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;2*geom.R&#39;</span><span class="p">,</span> <span class="s">&#39;diameter&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">regulated</span><span class="p">:</span>
        <span class="n">assembly</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;powercurve.ratedConditions&#39;</span><span class="p">,</span> <span class="s">&#39;ratedConditions&#39;</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">RotorAeroVSVP</span><span class="p">(</span><span class="n">Assembly</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">varspeed</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">varpitch</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">common_io</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varspeed</span><span class="p">,</span> <span class="n">varpitch</span><span class="p">)</span>
        <span class="n">common_configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varspeed</span><span class="p">,</span> <span class="n">varpitch</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">RotorAeroVSFP</span><span class="p">(</span><span class="n">Assembly</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">varspeed</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">varpitch</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">common_io</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varspeed</span><span class="p">,</span> <span class="n">varpitch</span><span class="p">)</span>
        <span class="n">common_configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varspeed</span><span class="p">,</span> <span class="n">varpitch</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">RotorAeroFSVP</span><span class="p">(</span><span class="n">Assembly</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">varspeed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">varpitch</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">common_io</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varspeed</span><span class="p">,</span> <span class="n">varpitch</span><span class="p">)</span>
        <span class="n">common_configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varspeed</span><span class="p">,</span> <span class="n">varpitch</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">RotorAeroFSFP</span><span class="p">(</span><span class="n">Assembly</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">varspeed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">varpitch</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">common_io</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varspeed</span><span class="p">,</span> <span class="n">varpitch</span><span class="p">)</span>
        <span class="n">common_configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varspeed</span><span class="p">,</span> <span class="n">varpitch</span><span class="p">)</span>





<span class="c"># class RotorAeroVS(Assembly):</span>

<span class="c">#     # --- inputs ---</span>
<span class="c">#     # rho = Float(1.225, iotype=&#39;in&#39;, units=&#39;kg/m**3&#39;, desc=&#39;density of air&#39;)</span>
<span class="c">#     control = VarTree(VarSpeedMachine(), iotype=&#39;in&#39;)</span>

<span class="c">#     # options</span>
<span class="c">#     npts_coarse_power_curve = Int(20, iotype=&#39;in&#39;, desc=&#39;number of points to evaluate aero analysis at&#39;)</span>
<span class="c">#     npts_spline_power_curve = Int(200, iotype=&#39;in&#39;, desc=&#39;number of points to use in fitting spline to power curve&#39;)</span>
<span class="c">#     AEP_loss_factor = Float(1.0, iotype=&#39;in&#39;, desc=&#39;availability and other losses (soiling, array, etc.)&#39;)</span>

<span class="c">#     # slots (must replace)</span>
<span class="c">#     geom = Slot(GeomtrySetupBase)</span>
<span class="c">#     analysis = Slot(AeroBase)</span>
<span class="c">#     dt = Slot(DrivetrainLossesBase)</span>
<span class="c">#     cdf = Slot(CDFBase)</span>

<span class="c">#     # --- outputs ---</span>
<span class="c">#     AEP = Float(iotype=&#39;out&#39;, units=&#39;kW*h&#39;, desc=&#39;annual energy production&#39;)</span>
<span class="c">#     V = Array(iotype=&#39;out&#39;, units=&#39;m/s&#39;, desc=&#39;wind speeds (power curve)&#39;)</span>
<span class="c">#     P = Array(iotype=&#39;out&#39;, units=&#39;W&#39;, desc=&#39;power (power curve)&#39;)</span>
<span class="c">#     ratedConditions = VarTree(RatedConditions(), iotype=&#39;out&#39;)</span>
<span class="c">#     diameter = Float(iotype=&#39;out&#39;, units=&#39;m&#39;)</span>


<span class="c">#     def configure(self):</span>

<span class="c">#         self.add(&#39;geom&#39;, GeomtrySetupBase())</span>
<span class="c">#         self.add(&#39;setup&#39;, SetupRun())</span>
<span class="c">#         self.add(&#39;analysis&#39;, AeroBase())</span>
<span class="c">#         self.add(&#39;dt&#39;, DrivetrainLossesBase())</span>
<span class="c">#         self.add(&#39;powercurve&#39;, RegulatedPowerCurve())</span>
<span class="c">#         self.add(&#39;brent&#39;, Brent())</span>
<span class="c">#         self.add(&#39;cdf&#39;, CDFBase())</span>
<span class="c">#         self.add(&#39;aep&#39;, AEP())</span>

<span class="c">#         self.brent.workflow.add([&#39;powercurve&#39;])</span>

<span class="c">#         self.driver.workflow.add([&#39;geom&#39;, &#39;setup&#39;, &#39;analysis&#39;, &#39;dt&#39;, &#39;brent&#39;, &#39;cdf&#39;, &#39;aep&#39;])</span>

<span class="c">#         # connections to setup</span>
<span class="c">#         self.connect(&#39;control&#39;, &#39;setup.control&#39;)</span>
<span class="c">#         self.connect(&#39;geom.R&#39;, &#39;setup.R&#39;)</span>
<span class="c">#         self.connect(&#39;npts_coarse_power_curve&#39;, &#39;setup.npts&#39;)</span>

<span class="c">#         # connections to analysis</span>
<span class="c">#         self.connect(&#39;setup.Uhub&#39;, &#39;analysis.Uhub&#39;)</span>
<span class="c">#         self.connect(&#39;setup.Omega&#39;, &#39;analysis.Omega&#39;)</span>
<span class="c">#         self.connect(&#39;setup.pitch&#39;, &#39;analysis.pitch&#39;)</span>
<span class="c">#         self.analysis.run_case = &#39;power&#39;</span>

<span class="c">#         # connections to drivetrain</span>
<span class="c">#         self.connect(&#39;analysis.P&#39;, &#39;dt.aeroPower&#39;)</span>
<span class="c">#         self.connect(&#39;analysis.Q&#39;, &#39;dt.aeroTorque&#39;)</span>
<span class="c">#         self.connect(&#39;analysis.T&#39;, &#39;dt.aeroThrust&#39;)</span>
<span class="c">#         self.connect(&#39;control.ratedPower&#39;, &#39;dt.ratedPower&#39;)</span>

<span class="c">#         # connections to powercurve</span>
<span class="c">#         self.connect(&#39;control&#39;, &#39;powercurve.control&#39;)</span>
<span class="c">#         self.connect(&#39;setup.Uhub&#39;, &#39;powercurve.Vcoarse&#39;)</span>
<span class="c">#         self.connect(&#39;dt.power&#39;, &#39;powercurve.Pcoarse&#39;)</span>
<span class="c">#         self.connect(&#39;analysis.T&#39;, &#39;powercurve.Tcoarse&#39;)</span>
<span class="c">#         self.connect(&#39;geom.R&#39;, &#39;powercurve.R&#39;)</span>
<span class="c">#         self.connect(&#39;npts_spline_power_curve&#39;, &#39;powercurve.npts&#39;)</span>

<span class="c">#         # setup Brent method to find rated speed</span>
<span class="c">#         self.connect(&#39;control.Vin&#39;, &#39;brent.lower_bound&#39;)</span>
<span class="c">#         self.connect(&#39;control.Vout&#39;, &#39;brent.upper_bound&#39;)</span>
<span class="c">#         self.brent.add_parameter(&#39;powercurve.Vrated&#39;, low=-1e-15, high=1e15)</span>
<span class="c">#         self.brent.add_constraint(&#39;powercurve.residual = 0&#39;)</span>

<span class="c">#         # connections to cdf</span>
<span class="c">#         self.connect(&#39;powercurve.V&#39;, &#39;cdf.x&#39;)</span>

<span class="c">#         # connections to aep</span>
<span class="c">#         self.connect(&#39;cdf.F&#39;, &#39;aep.CDF_V&#39;)</span>
<span class="c">#         self.connect(&#39;powercurve.P&#39;, &#39;aep.P&#39;)</span>
<span class="c">#         self.connect(&#39;AEP_loss_factor&#39;, &#39;aep.lossFactor&#39;)</span>


<span class="c">#         # connections to outputs</span>
<span class="c">#         self.connect(&#39;powercurve.V&#39;, &#39;V&#39;)</span>
<span class="c">#         self.connect(&#39;powercurve.P&#39;, &#39;P&#39;)</span>
<span class="c">#         self.connect(&#39;aep.AEP&#39;, &#39;AEP&#39;)</span>
<span class="c">#         self.connect(&#39;powercurve.ratedConditions&#39;, &#39;ratedConditions&#39;)</span>
<span class="c">#         self.connect(&#39;2*geom.R&#39;, &#39;diameter&#39;)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li><a href="../../index.html">RotorSE 0.1.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, NREL.
      Last updated on Oct 07, 2014.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>